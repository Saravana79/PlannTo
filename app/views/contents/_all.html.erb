<div id="content_all">
  <!--filter by block start here-->
  <div id="Filterby">
    <div class="Filternav">
      <div style="float:left;width:60px;">
        <span style="padding:2px 5px 0px 0px;"><b>Filter by:</b></span>
      </div>
      <div style="float:left;width:630px;">

        <ul>
          <li class="Currentfilter" id="All"><a href="#">All</a></li>
          <%@article_categories.each do |category|%>
             <%if category[0]== "HowTo/Guide"%>
                  <li id="HowTo"><a href=""><%=category[0]%></a></li>
                <%else%>
                <li id="<%=category[0]%>"><a href=""><%=category[0]%></a></li>
                <%end%>

            
          <%end%>
        </ul>
      </div>
    </div>
  </div>
  <script type="text/javascript">
  
    $(document).ready(function(){
    	$("span#sortBy a").click(function (e) {
  		 $("span#sortBy").find('a').removeClass('link_active');
        $(this).addClass("link_active");
          if ($("#content_search_search").val().toString() == ""){
          	$("#filter_page_no").val(1)
          	
          	var sub_type =  $("div#Filterby div.Filternav ul li.Currentfilter").text()
          	var items = "<%=@item.id%>"
          var filter_page_no = $("#filter_page_no").val()
          var itemtype_id = "<%=@item.get_base_itemtypeid()%>"
          var sort_by = $(this).text()
          var action = "filter"
          contentSearchFilterAction(action, sub_type, items, filter_page_no, itemtype_id, sort_by);         
          return false
           }
           else{
         $("#content_search_page").val(1);
         $("#content_search_sort_by").val($(this).text());
         $("#contentSearchForm").bind('ajax:complete', function() { running = false});
         $("#contentSearchForm").submit()        
       
         }
        
  	});

      $("div#Filterby div.Filternav ul li").click(function (e) {
        $("div#Filterby div.Filternav ul").find('li').removeClass('Currentfilter');
        $(this).closest('li').addClass("Currentfilter");
        if ($(this).text() != "Labeltext"){
          
          var id = $(this).attr('id');          
          switch(id){
            case 'All' :  var sub_type = "All";break;
            case 'HowTo': var sub_type = "HowTo/Guide";break;
            case 'Q&A': var sub_type = "QandA";break;
            default:  var sub_type = id;
          }
          $("#filter_page_no").val('1');
          $("#content_search_page").val(1)
          $("#content_search_search").val("")
          $("#content_search_sub_type").val(sub_type);
          
          var items = "<%=@item.id%>"
          var filter_page_no = $("#filter_page_no").val()
          var itemtype_id = "<%=@item.get_base_itemtypeid()%>"
          var sort_by = $("span#sortBy a.link_active").text();
          var action = "filter"
          contentSearchFilterAction(action, sub_type, items, filter_page_no, itemtype_id, sort_by); 
          return false
        }
      });
      <%if params[:fl].present?%>
      $("div#Filterby div.Filternav ul li#<%=params[:fl]%>").trigger("click");
      <%end%>
    });
  </script>
  <div style="border-bottom:solid 1px #e4e4e4;;clear:both;padding-top:5px;"></div>
  <div>
    <span class="sortby" id="sortBy">
      <span style="padding:2px 5px 0px 0px;"><b>Sort by:</b></span>
       <a class="txt_blue" href="#"  class="link_active">Newest</a> <span style="padding:0px 5px;">|</span>
        <a class="txt_blue" href="#">Votes</a> <span style="padding:0px 5px;">|</span>
        <a class="txt_blue" href="#">Most Comments</a>
        <%= form_for :content_search, :url => {:controller => "contents", :action => "search_contents"}, :remote => true, :html => { :style => "float:right;", :id => "contentSearchForm"} do |f| -%>
			<%= f.text_field :search, :class => "txt_gray new_comment", :size => "20", "placeholder"=> "Search content" %>
			<%= f.hidden_field :sub_type %>
			<%= f.hidden_field :itemtype_ids, :value => @item.try(:itemtype_id) %>
			<%= f.hidden_field :item_ids, :value => @item.id%>	
			<%= f.hidden_field :previous_search_value%>
			<%= f.hidden_field :page, :value =>1%>
		<% end -%>  
    </span>    
     
  </div>
  <div style="border-bottom:solid 1px #e4e4e4;;clear:both;"></div>
  <div style="border-bottom:solid 1px #e4e4e4;;clear:both;" id="contentsList">
    <%if @item.show_models %>
      <% params = {"items" => @item.related_cars.collect(&:id), "status" => 1 } %>
    <% else %>
      <% params = {"items" => [@item.id], "status" => 1  }%>
    <% end %>

    <% @contents = Content.filter(params)  %>
    <%= render :partial => 'contents/contents', :locals => {:params => params} %>
  </div>
  <a id="content_next" style="display:none"></a>
  <%=hidden_field_tag :filter_page_no, @contents.current_page+ 1%>
</div>

<script type="text/javascript" charset="utf-8">
  $(function(){
    $('#load_content').live("click",function(){
      type='';
      $('#filter_contents :checked').each(function(){
        type+="&type[]="+$(this).attr("class");
      });
<% unless @item.blank? %>
        var url = "<%= feed_contents_path(:items => @item.id  ) %>";
<% else %>
        var url = "<%= feed_contents_path %>";
<% end %>
      $("#content_all").html("");
      url=url+"&limit=5"+type;
      $.get(url, function(data) {
        $("#content_all").html(data);
      });
    });

    $('#select_all').click(function(){
      if($('#select_all').is(':checked')){
        $('#filter_contents input').attr('checked','checked');
      }
      else {
        $('#filter_contents input').removeAttr('checked');
      }
    });
    
      $(document).ready(function(){
    $(window).scroll(function () {
		
      lnk = $('#content_next');
      if (!running && lnk && $(window).scrollTop() >= $('#content_all').height() - $(window).height()) {
     
        running = true;
        if ($("#content_search_search").val().toString() == ""){
        	var id = $("div#Filterby div.Filternav ul li.Currentfilter").text();          
          switch(id){
            case 'All' :  var sub_type = "All";break;
            case 'HowTo': var sub_type = "HowTo/Guide";break;
            case 'Q&A': var sub_type = "QandA";break;
            default:  var sub_type = id;
          }
          var items = "<%=@item.id%>"
          var filter_page_no = $("#filter_page_no").val()
          var itemtype_id = "<%=@item.get_base_itemtypeid()%>"
          var sort_by = $("span#sortBy a.link_active").text();
          var action = "feeds"
          contentSearchFilterAction(action, sub_type, items, filter_page_no, itemtype_id, sort_by);        
        return false
        //lnk.click();
      }
        else
      {
      	$("#contentSearchForm").bind('ajax:complete', function() { running = false});
    	$("#contentSearchForm").submit()
    	
    	 return false 
    	 
      }
      }
    
    });
   }); 
  });
  
  function contentSearchFilterAction(action, sub_type, items, filter_page_no, itemtype_id, sort_by){
  	 $.get("/contents/" + action ,
  	 {sub_type: sub_type, items: items, page: filter_page_no, itemtype_id: itemtype_id, sort_by: sort_by},
     
          function(data, status, xhr)
          {
            running = false;
          }
        );  
       }
</script>
