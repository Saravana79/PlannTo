<!DOCTYPE html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Plannto Widget</title>
  <link href="<%= configatron.root_image_path %>static/stylesheets/widget/300_250/style.css" type="text/css" rel="stylesheet" media="all"/>
  <%= javascript_include_tag "https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" %>
</head>
<body>

<div class="plannto-advertisement main_div" style="cursor:pointer;">
  <div class="advt-block">
    <div class="advt-300">
      <!--<div class="planntoadlogo">
      <%#= link_to image_tag("#{configatron.root_image_path}static/images/logosc.png", :width => "12px"), configatron.hostname + "/opt_out", :target => "_blank" %>
    </div>
  -->
      <div class="logo">
        <div style="float:left;width:110px;">
          <a class="vendor_image" href="javascript:void(0)" target="_blank"><img src="<%= @vendor_image_url="" %>" alt="">
          </a>
        </div>
        <div class="list_carousel">
          <div id="pager2" class="pager">
            <%if @where_to_buy_items.count > 1 %>
                <% [*1..@where_to_buy_items.count].each do |each_loop| %>
                    <a href="javascript:void(0)" id="<%= each_loop %>" class=""><span> <%= each_loop %></span></a>
                <% end %>
            <% end %>
          </div>
        </div>
        <div class="clearfix"></div>
      </div>

      <% if @where_to_buy_items.count != 0 %>
          <div class="divshadow">
            <ul id="foo3" height="190px;" style="margin:0px;text-indent:0;">
              <% @where_to_buy_items.each_with_index do |item_detail, indx| %>
                  <% ad_url = get_ad_url(item_detail.id, @impression_id, @ref_url, @sid, params[:ads_id], params, item_detail) %>
                  <% shop_now_url = @click_url.blank? ? ad_url : (@click_url+ad_url) %>

                  <li class="item_details" id="item_detail_<%= indx + 1 %>" style="list-style-position:outside;margin: 0px;">
                    <div class="advt-box">
                      <div class="product-container">
                        <div class="product-img-left" style="height:145px;">
                          <a href="<%= shop_now_url %>" target="_blank">
                            <span style="  display: inline-block;height: 100%;vertical-align: middle;"></span>
                            <%= get_image_tag(item_detail, @vendor_ad_details[item_detail.site.to_i]['vendor_name'], @item.base_item_image_url(:medium), 132, '').html_safe %>
                            <!-- <img src="<%#= get_image_url(item_detail, @vendor_ad_details[item_detail.site.to_i]['vendor_name']) %>" onerror="this.error=null;this.src='<%#=@item.base_item_image_url(:medium)%>';" alt="" width="132px"> -->
                          </a>
                        </div>
                        <div class="product-txt-right">
                          <a href="<%= shop_now_url %>" target="_blank" class="">
                            <h3 style="font-family:Arial;line-height:20px;"><%= item_detail.ItemName.to_s.truncate(62) %></h3>

                            <p class="price"><%= prettify(item_detail) %></p>
                          </a>

                          <p class="btn">
                            <a href="<%= shop_now_url %>" target="_blank" class="shop-now">
                              <%= @vendor_detail.action_text.blank? ? "Shop Now" : @vendor_detail.action_text %>
                            </a>
                          </p>

                        </div>
                      </div>
                      <div class="product-txt-desc">
                        <p>
                          <%#= truncate_without_dot(get_offer_for_ad(@ad, item_detail, @vendor_ad_details[item_detail.site.to_i]['default_text']), 90) %>
                          <%= raw get_offer_for_ad(@ad, item_detail, @vendor_ad_details[item_detail.site.to_i]['default_text'], 90, shop_now_url) %>
                        </p>
                      </div>
                    </div>
                    <img class="vendor_image_src" src="<%= @vendor_ad_details[item_detail.site.to_i]['imageurl'] %>" alt="" style="display: none;">
                  </li>
              <% end %>
            </ul>
          </div>
          <div class="clearfix"></div>
          <!--<a id="prev3" class="prev" href="#">&lt;</a>
          <a id="next3" class="next" href="#">&gt;</a>
         -->

      <% else %>
          No Product Found
      <% end %>

    </div>
    <!-- end of advt-300 -->
  </div>
  <!-- end of advt-block -->

  <style type="text/css">
      .pager a {
          margin: 0px !important;
      }

      .product-container a {text-decoration: none !important;}

      .advt-box .product-container h3 {
          font-size: 14px !important;
      }
  </style>
</div>
<%= hidden_field_tag :present_item_id, @item.blank? ? "" : @item.id, :id => "present_item_id=#{@item.blank? ? "" : @item.id}#" %>
</body>
</html>

<style type="text/css">
    .main_div {
        width: <%= @iframe_width %>px !important;
        height: <%= @iframe_height %>px !important;
        overflow: hidden;
    }

    h3.product-title {word-break: break-all;}

    .product-txt-desc p a {text-decoration: none;}

    a#offer_ad {
        color:#222 !important;
        font-family: Arial !important;
        font-size: 10px !important;
        margin: 0;
        padding: 0;
        text-decoration: none;
        font-weight: 600;
    }

    a#offer_ad:hover
    {
        color: #009CC4 !important;

    }

    .ad_img_tag {
        max-height: 180px;
    }
</style>

<script type="text/javascript">
    jQuery(document).ready(function () {
        //hide pixel img
        jQuery(".plannto-advertisement").siblings("img").hide()

        jQuery(".ad_img_tag").on("error", function()
        {
            var img_id = jQuery(this).attr('id')
            if (img_id == "item_details") {
                jQuery(this).attr('id', 'item')
                jQuery(this).attr("src", jQuery(this).attr('next_src'))
            }
            else if (img_id == "item")
            {
                jQuery(this).attr('id', 'default_image')
                jQuery(this).attr("src", jQuery(this).attr('default_src'))
            }
        });

        var stop_sliding = false

        jQuery(".item_details").hide();
        jQuery(".item_details").first().show();
        jQuery(".item_details").first().addClass('active')
        set_logo_url(jQuery(".item_details").first(), "shop-now")

        jQuery("#1").addClass('selected')

// TODO: temporary commented
        <% if (@ad_template_type == "type_5" || (!@ad.blank? && @ad.sort_type == "random")) %>
        jQuery(".item_details").each(function (index) {

            if (index == 0)
                return

            var that = this;
            var t = setTimeout(function () {
                if (stop_sliding == false) {
                    jQuery(".item_details").hide();
                    jQuery(".item_details").removeClass('active')
                    jQuery("#pager2 a").removeClass('selected')

                    split_div = jQuery(that).attr('id').split('_')
                    jQuery("#" + split_div[split_div.length - 1]).addClass('selected')

                    jQuery(that).show();
                    jQuery(that).addClass('active')
                    set_logo_url(that, "shop-now")

                    if (index == (jQuery(".item_details").length - 1))
                        setTimeout(function () {
                            if (stop_sliding == false) {
                                jQuery(".item_details").last().hide()
                                jQuery(".item_details").removeClass('active')
                                jQuery("#pager2 a").removeClass('selected')
                                jQuery(".item_details").first().show();
                                jQuery(".item_details").first().addClass('active')
                                set_logo_url(jQuery(".item_details").first(), "shop-now")

                                jQuery("#1").addClass("selected")
                            }
                        }, 5000)
                }
            }, 5000 * index);
        });

        <% end %>

        jQuery(".next").click(function () {
            var current_div = jQuery(".item_details.active")
            jQuery(".item_details").hide();
            jQuery(".item_details").removeClass('active')
            jQuery("#pager2 a").removeClass('selected')

            var splited_val = jQuery(current_div).attr("id").split('_')

            if (parseInt(splited_val[splited_val.length - 1]) < jQuery(".item_details").length) {
                jQuery(current_div).next().show().addClass('active')
                set_logo_url(jQuery(current_div).next(), "shop-now")

                split_div = jQuery(current_div).next().attr("id").split('_')
                jQuery("#" + split_div[split_div.length - 1]).addClass('selected')
            }
            else {
                jQuery(".item_details").first().show().addClass('active')
                set_logo_url(jQuery(".item_details").first(), "shop-now")

                jQuery("#1").addClass('selected')
            }
        });


        jQuery(".prev").click(function () {
            var current_div = jQuery(".item_details.active")
            jQuery(".item_details").hide();
            jQuery(".item_details").removeClass('active')
            jQuery("#pager2 a").removeClass('selected')

            var splited_val = jQuery(current_div).attr("id").split('_')

            if (parseInt(splited_val[splited_val.length - 1]) > 1) {
                jQuery(current_div).prev().show().addClass('active')
                set_logo_url(jQuery(current_div).prev(), "shop-now")

                split_div = jQuery(current_div).prev().attr("id").split('_')
                jQuery("#" + split_div[split_div.length - 1]).addClass('selected')
            }
            else {
                jQuery(".item_details").last().show().addClass('active')
                set_logo_url(jQuery(".item_details").last(), "shop-now")

                last = jQuery(".item_details").length
                jQuery("#" + last).addClass('selected')
            }
        });

        jQuery("#pager2 a").click(function () {
            var that = this
            selected_id = jQuery(that).attr("id")
            selected_div = jQuery("#item_detail_" + selected_id)

            jQuery(".item_details").hide();
            jQuery(".item_details").removeClass('active')

            jQuery(selected_div).show()
            jQuery(selected_div).addClass('active')
            set_logo_url(jQuery(selected_div), "shop-now")

            jQuery("#pager2 a").removeClass('selected')
            jQuery(that).addClass('selected')
        })

        jQuery(".advt-block").click(function () {
            stop_sliding = true
        })

//        jQuery(".plannto-advertisement").click(function(event)
//        {
//            check_navigation = jQuery(event.target).closest('#pager2')
//
//            console.log(check_navigation)
//
//            if (check_navigation.size() == 0)
//            {
//                event.preventDefault()
//                url = jQuery(".shop-now").attr('href')
//                window.open("http://"+url);
//            }
//        })

        // All place clickable

        jQuery(".plannto-advertisement.main_div").click(function(a)
        {
            var ids_list = []
            ids_list.push(a.target.id)
            ids_list.push(a.target.parentNode.id)
            ids_list.push(a.target.parentNode.parentNode.id)
            var present = jQuery.inArray("pager2", ids_list)
            if (present < 0)
            {
                <% if ["728", "120", "160_600"].include?(@suitable_ui_size) %>
                var x = a.target
                var d = jQuery(x).closest(".product-container")
                var shop_now_url = d.find(".shop-now").attr('href')
                <% else %>
                var x = a.target
                var d = jQuery(x).closest(".advt-box")
                var shop_now_url = d.find(".shop-now").attr('href')
                <% end %>

                if (shop_now_url == undefined)
                {
                    var shop_now_url = jQuery(".item_details.active").find(".shop-now").attr('href')
                }

                window.open(shop_now_url, "_blank")
                return false;
            }
        });

        jQuery(".car_extra_link_ad").click(function()
        {
            var href = jQuery(this).attr("href")

            window.open(href, "_blank")
            return false;
        })

    });

    function set_logo_url(that, class_name)
    {
        var href_val = jQuery(that).find("."+class_name).attr('href')

        var image_src = jQuery(that).find(".vendor_image_src").attr('src')

        if (href_val == "" || href_val == undefined)
        {
            href_val = jQuery("."+class_name).attr('href')
        }
        jQuery(".logo").find('a img').attr('src', image_src)
        jQuery(".logo").find('a.vendor_image').attr('href', href_val)
    }
</script>