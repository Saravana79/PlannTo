<% content_for :title, "Browse " + @search_type.pluralize.humanize + " - " %>
<% content_for :description, "Search all available, latest and upcoming" + @search_type.pluralize.humanize + " in India."%>
<div id="maincontainer" class="maincontainerCss">

  <div class="leftcolumnsmall">
    <ul class="search_criteria">
      <div class="hdr_search">Search Criteria:</div>
      <a href="" >Current <%=@search_type.pluralize.humanize%></a><%= check_box_tag "current_status", 1, true,:onclick => "setSearchStatus();"%>
      <a href="" >Future <%=@search_type.pluralize.humanize%></a><%= check_box_tag "future_status", 2, false, :onclick => "setSearchStatus();"%>
      <a href="" >Nonavailable <%=@search_type.pluralize.humanize%></a><%= check_box_tag "nonavailable_status", 3, false, :onclick => "setSearchStatus();" %>
      <%@search_info_lookups.each_with_index do |lookup, index|%>
        <%if index == 0%>
          <li id="manufacturerAtt" onclick="openManufacturerBox('Car', this);return false" class="<%="#{lookup[:param_1][:div_class_name]}"%>"><a href="" >Manufacturer</a></li>

        <%end%>
        <li   class='<%="#{lookup[:param_1][:div_class_name]}"%>' id="attribute_menu_<%=index%>" onclick="openInfoBox(<%=lookup[:param_1].to_json%>, '<%=lookup[:param_2].to_json%>', this );return false"><a href=""><%=lookup[:name]%></a></li>
      <%end%>
    </ul>
  </div>
  <%= render :partial => "shared/search_popup" %>
  <div class="rightcolumnbig">
    <div class="searchPack" style="display: none;">
      <div class="hdr_Category">Search Preferences:</div>
      <ul class="search_category">
      </ul>
      <br/>
      <div id="btnDiv" style="height:100px;display:block;">
        <a href="#" class="btn_gray float_lft" style="display:none;" id="clearTag">Clear All</a>
        <!--<a href="#" class="btn_submitanswer float_rgt" style="width:150px;display:none;" id="addPreferenceTag">Create Buying Plan</a>-->
        <a href="#" class="btn_submitanswer float_rgt" style="width:130px;display:none;" id="getAdviceTag">Create/Update Buying Plan</a>
      </div>
    </div>
    <div class="push"></div>
    <div id="content">
      <%= render :partial => "/search/index" %>
    </div>
  </div>

</div>
<%= form_for(:search, :url =>{:action=>"index",:controller=>"search"}, :html => { :method => :post, :id => "searchForm"}) do |f| %>
  <%= hidden_field_tag :page %>
  <%= hidden_field_tag :status, 1%>
  <%= hidden_field_tag :search_type, @search_type %>
  <%= hidden_field_tag :sort_by, @sort_by %>
  <%=hidden_field_tag :manufacturer%>
  <%@search_form_lookups.each do |form_list|%>
    <%=hidden_field_tag form_list[:field_name].to_sym%>
  <%end%>
<%end%>

<div id="getAdviceDialog" title="I am looking for an advice" style="display:none">
</div>

<div class="push"></div>
<script type="text/javascript">

function store_status_ids(type, sender) {

    var value_selector = "#" + type +""

    if ($(value_selector).val() == "") {
        var ids = [];
    } else {
        var ids = $(value_selector).val().split(",");
    }
    var add = true
    $.each(ids, function(index, value) {
        if (value.toString() == sender.toString())  {
            add = false;
        }
    });
    if (add == true){
        ids.push(sender);
    }
    $(value_selector).val(ids.toString());
};

  function setSearchStatus(){
  	$("#status").val('');
if ($('#future_status').is(':checked')) {
	store_status_ids("status", 2)
}
if ($('#current_status').is(':checked')) {
	store_status_ids("status", 1)
}
if ($('#nonavailable_status').is(':checked')) {
	store_status_ids("status", 3)
}

  	
  }
  function resetUnwantedFormFields(){
<%@search_info_lookups.each_with_index do |value, index|%>
      var searchListId = "attribute_menu_" + <%=index%> + "_tag"
       var formId = <%= value[:id] %>
        var valueType = "<%= value[:param_1][:vt] %>"
      //click option has multiple values and hence before we reset the values we need
      //to check whether other field values is already set in search criteria or not.
       if (valueType == "Click"){
       	var reset = "true"
       	<%@search_info_lookups.select {|s| s[:id] == value[:id]}.each do |form_value|%>
       	
       	<%index = @search_info_lookups.index(form_value)%>
       	var multipleClickSearchListId = "attribute_menu_" + <%=index%> + "_tag"
       	if ($(".search_category").find("#" +multipleClickSearchListId).length != 0){
        			reset = "false"
        		}    
       	<%end%>   
        if (reset == "true"){
        	 $("#" + formId).val('')
        }         
        } 
      else if ($(".search_category").find("#" + searchListId).length == 0){           
        if (valueType == "Between"){
          $("#min_" + formId).val('')
          $("#max_" + formId).val('')
        }        
        else{
          $("#" + formId).val('')
        }
      }
<%end%>
  }

  function showPreferenceTag(){
<% if user_signed_in? %>
      if ($(".search_category").find("li").length == 0){
        $("#addPreferenceTag").show();
      }
<%end%>
  }

  function showGetAdviceTag(){
<% if user_signed_in? %>
      if ($(".search_category").find("li").length == 0){
        $("#getAdviceTag").show();
      }
<%end%>
  }
  //LOAD PREFERENCE TAGS AND SETTING UP FORM FIELDS WITH PREFERENCE VALUES///////////
<%# if user_signed_in? %>
    $("#page").val(1);
  <%if @preferences_list.size > 0%>
      showSearchPack()
      showClearTag();
      showPreferenceTag();
      showGetAdviceTag();
  <%end%>
  <%@preferences_list.each do |preference|%>
      var lineHeight = "";
      var searchCriteria = "";
      var index = "<%=@search_info_lookups.index{|x|x[:id]== preference[:attribute]}%>"
      var searchName = "<%=preference[:search_name]%>"
      var tagId = "attribute_menu_" + index + "_tag"
    <%if preference[:value_type] == "Between"%>
        var minFieldId = "<%=preference[:min_attribute]%>"
        var maxFieldId = "<%=preference[:max_attribute]%>"
        var minValue   = "<%=preference[:min_value]%>"
        var maxValue   = "<%=preference[:max_value]%>"
        $("#" + minFieldId).val(minValue)
        $("#" + maxFieldId).val(maxValue)
        searchCriteria = ""
        searchCriteria   = searchCriteria + "<%=preference[:search_criteria]%>"
           var className = "middlebg attributeTag"
        var list = "<li id='" + tagId + "'" + " class='" + className +"'><span class='title_txt'>" + searchName + "<a id= 'deleteTag' class='icon_close'></a></span>" + searchCriteria + "</li>" ;
    <%elsif (preference[:value_type] == "GreaterThan" || preference[:value_type] == "LessThen")%>
        var fieldId = "<%="#{preference[:attribute]}"%>"
        var value   = "<%="#{preference[:value]}"%>"
        $("#" + fieldId).val(value)
        searchCriteria = ""
        searchCriteria   = searchCriteria + "<%=preference[:search_criteria]%>"
        var value = searchCriteria
        var searchCriteria = "<span class='txt_subcategories'>" + value +"</span>"
        var className = "middlebg attributeTag"
        var list = "<li id='" + tagId + "'" + " class='" + className +"'><span class='title_txt'>" + searchName + "<a id= 'deleteTag' class='icon_close'></a></span>" + searchCriteria + "</li>" ;
    <%elsif (preference[:value_type] == "ListOfValues" || preference[:value_type] == "manufacturer")%>
        <%if preference[:value_type] == "manufacturer"%>      
        tagId = "manufacturerAtt_tag"
        <%end%>
        var fieldId = "<%="#{preference[:attribute]}"%>"
        var value   = "<%="#{preference[:value]}"%>"
        var selectedList = value.split(',')
        var searchCriteria = ""
        var anchorId
        var spanId = 'removableListofValues' + fieldId
        var spanHTML = ""
        $.each(selectedList, function(index, value) {
          anchorId = "removeThis_" + index + "_" + fieldId
          spanHTML = spanHTML + "<span class='txt_subcategories'>" + value + "<a class='icon_close1 removableList' id='" + anchorId + "' href='#'></a></span>"
        })
        searchCriteria = searchCriteria + spanHTML
        var className = "middlebg attributeTag"
        var list = "<li id='" + tagId + "'" + " class='" + className +"'><span class='title_txt'>" + searchName + "<a id= 'deleteTag' class='icon_close'></a></span>" + searchCriteria + "</li>" ;
        var fieldId = "<%="#{preference[:attribute]}"%>"
        var value   = "<%="#{preference[:value]}"%>"
        $("#" + fieldId).val(value)
    <%else%>
        var fieldId = "<%="#{preference[:attribute]}"%>"
        var value   = "<%="#{preference[:value]}"%>"
        $("#" + fieldId).val(value)
        var list = "<li id='" + tagId + "'" + " class='middlebg'  style= 'height:40px;'><span class='title_txt'>" + searchName  + "<a id= 'deleteTag' class='icon_close'></a></span></li>" ;
    <%end%>
      $(list).appendTo('.search_category');
  <%end%>
<%#end%>  


  $('#deleteTag').live('click', function(){
  	//removing first to handle clearing the form values for the currently removed tag as well.
  	$(this).closest('li').remove();
    hideClearTag();
    hideSearchPack();
    var tagId = $(this).closest('li').attr('id');
    var attributeId = tagId.substring(0, tagId.indexOf("_tag"));
    $("#" + attributeId).show();
    if (attributeId == "manufacturerAtt"){
      $("#manufacturer").val('');
    }
    else{
      var attributeIndex = attributeId.replace('attribute_menu_',''); //substring(0, tagId.indexOf("attribute_menu_"));
		<%@search_info_lookups.each_with_index do |lookup, index|%>
        if (<%=index%> == attributeIndex){
          var valueType = "<%=lookup[:param_1][:vt]%>"
          var attributeId = "<%=lookup[:id]%>"
           //click option has multiple values and hence before we reset the values we need
      //to check whether other field values is already set in search criteria or not.
          if (valueType == "Click"){
      var reset = "true"
       	<%@search_info_lookups.select {|s| s[:id] == lookup[:id]}.each do |form_value|%>
       	
       	<%index = @search_info_lookups.index(form_value)%>
       	var multipleClickSearchListId = "attribute_menu_" + <%=index%> + "_tag"
       	if ($("#" +multipleClickSearchListId).length != 0){
        			reset = "false"
        		}    
       	<%end%>   
        if (reset == "true"){
        	 $("#" + attributeId).val('')
        }          
        } 
         else if (valueType == "Between"){
            $("#min_" + attributeId).val('');
            $("#max_" + attributeId).val('');
          }
          else{
            $("#" + attributeId).val('');
          }
        }
<%end%>
    }

    //$.get('/search',$("#searchForm").serialize(),null,"script");
    searchData('spinner');
    return false;
  })
</script>
<script type="text/javascript"> 
  function resetFormData(){
    $("#page").val(1);
    $("#manufacturer").val('')
<%@search_form_lookups.each do |form_list|%>
      $("#" + '<%=form_list[:field_name]%>').val('')
<%end%>
  } 
  
  function removeMultipleAttributeInstance(fieldId, tagId){
<%@search_info_lookups.each_with_index do |value, index|%>
      var searchListId = "attribute_menu_" + <%=index%> + "_tag"
      var formId = <%= value[:id] %>
      if ((formId == fieldId) && (searchListId != tagId)){
        if ($(".search_category").find("#" + searchListId).length != 0){
          $("#" + searchListId).remove();
          var attrField = searchListId.replace("_tag", "")
          $("#" + attrField).show();
        }
      }
<%end%>
  } 
  
</script>
